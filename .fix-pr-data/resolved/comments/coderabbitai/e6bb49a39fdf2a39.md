# Comment: e6bb49a39fdf2a39

**Source:** coderabbitai
**Type:** comment
**File:** `apps/backend/tests/integration/test_linear_mcp.py`
**Line:** 162
**Original ID:** 2737528196
**Created:** None
**Severity:** HIGH
**Status:** RESOLVED

---

## Original Content

_âš ï¸ Potential issue_ | _ğŸŸ  Major_

<details>
<summary>ğŸ§© Analysis chain</summary>

ğŸ Script executed:

```shell
# First, find and examine the LinearValidationAgent class and its create_client method
rg -n "class LinearValidationAgent" apps/backend -g '*.py' -A 10
```

Repository: AndyMik90/Auto-Claude

Length of output: 903

---

ğŸ Script executed:

```shell
# Search for create_client method definition
rg -n "def create_client" apps/backend -g '*.py' -A 15
```

Repository: AndyMik90/Auto-Claude

Length of output: 2830

---

ğŸ Script executed:

```shell
# Check for async context manager implementations (__aenter__, __aexit__)
rg -n "__aenter__|__aexit__" apps/backend -g '*.py' -B 2 -A 2
```

Repository: AndyMik90/Auto-Claude

Length of output: 5103

---

ğŸ Script executed:

```shell
# Look for run_agent_session usage in tests
rg -n "run_agent_session" apps/backend -g '*.py' -B 2 -A 5
```

Repository: AndyMik90/Auto-Claude

Length of output: 10036

---

ğŸ Script executed:

```shell
# Check the test file structure
cat -n apps/backend/tests/integration/test_linear_mcp.py | head -50
```

Repository: AndyMik90/Auto-Claude

Length of output: 1785

---

ğŸ Script executed:

```shell
# Check if ClaudeSDKClient is defined and its full interface
rg -n "class ClaudeSDKClient" apps/backend -g '*.py' -A 20
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Look at the actual create_client implementation details
cat -n apps/backend/core/client.py | sed -n '445,480p'
```

Repository: AndyMik90/Auto-Claude

Length of output: 2047

---

ğŸ Script executed:

```shell
# Check if there are any other synchronous tests creating clients
rg -n "def test_" apps/backend/tests -g '*.py' -B 2 -A 10 | grep -A 10 "create_client"
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Examine how LinearValidationAgent.create_client() is typically used
rg -n "agent.create_client()" apps/backend -g '*.py' -B 3 -A 3
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Check what type hints ClaudeSDKClient has for context manager
rg -n "ClaudeSDKClient" apps/backend/core/client.py -A 5 | head -40
```

Repository: AndyMik90/Auto-Claude

Length of output: 838

---

ğŸ Script executed:

```shell
# Check the type definition for ClaudeSDKClient from claude_agent_sdk
rg -n "class ClaudeSDKClient\|class MockClient\|__aenter__\|__aexit__" apps/backend/runners/github/testing.py -B 2 -A 5
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Look at actual usages of async with client in the codebase
rg -n "async with.*client" apps/backend -g '*.py' -B 2 -A 5
```

Repository: AndyMik90/Auto-Claude

Length of output: 22286

---

ğŸ Script executed:

```shell
# Check if there are synchronous tests that use client without async context
rg -n "def test_" apps/backend/tests -g '*.py' -A 20 | grep -B 5 -A 15 "\.create_client()"
```

Repository: AndyMik90/Auto-Claude

Length of output: 1882

---

ğŸ Script executed:

```shell
# Check the full LinearValidationAgent.create_client signature
cat -n apps/backend/agents/linear_validator.py | sed -n '346,380p'
```

Repository: AndyMik90/Auto-Claude

Length of output: 1465

---

ğŸ Script executed:

```shell
# Check if there are any other synchronous test methods that create clients without context managers
rg -n "def test_.*create_client" apps/backend/tests -g '*.py' -A 10
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Verify the test structure and what it's trying to accomplish
cat -n apps/backend/tests/integration/test_linear_mcp.py | sed -n '137,165p'
```

Repository: AndyMik90/Auto-Claude

Length of output: 1417

---



</details>

**Use the Claude client context manager to avoid resource leaks.**

The test creates a client but never closes it. Following the established pattern throughout the codebase, client creation must use the async context manager for proper resource handling.

<details>
<summary>â™»ï¸ Suggested fix</summary>

```diff
-    def test_linear_validation_agent_client_factory(self):
+    `@pytest.mark.asyncio`
+    async def test_linear_validation_agent_client_factory(self):
         """
         Test that LinearValidationAgent can create a client.
@@
-            try:
-                client = agent.create_client()
-                assert client is not None
-            except Exception as e:
+            try:
+                async with agent.create_client() as client:
+                    assert client is not None
+            except Exception as e:
                 # Client creation may fail if no Claude API credentials
                 # That's expected in some environments
                 pytest.skip(
                     f"Client creation failed (likely missing API credentials): {e}"
                 )
```
</details>

<details>
<summary>ğŸ¤– Prompt for AI Agents</summary>

```
In `@apps/backend/tests/integration/test_linear_mcp.py` around lines 137 - 162,
The test test_linear_validation_agent_client_factory creates a client via
LinearValidationAgent.create_client but never closes it; change the test to use
the client's async context manager so the resource is properly cleaned upâ€”make
the test async (or use pytest.mark.asyncio) and replace the direct call+assert
with an "async with agent.create_client() as client:" block, perform the assert
inside that block, and keep the existing exception handling/pytest.skip behavior
around the async creation to handle missing credentials.
```

</details>

<!-- fingerprinting:phantom:poseidon:eagle -->

<!-- This is an auto-generated comment by CodeRabbit -->

âœ… Addressed in commits 27f229e to 82a5f1f

---

## Suggested Fix

```python
</details>

<details>
<summary>ğŸ¤– Prompt for AI Agents</summary>
```

---

## Implementation Notes

*Status: RESOLVED*

**Resolution:** Body contains resolution marker

**Resolved At:** 2026-01-28T21:24:35.181485

