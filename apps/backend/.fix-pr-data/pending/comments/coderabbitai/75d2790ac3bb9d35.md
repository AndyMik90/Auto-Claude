# Comment: 75d2790ac3bb9d35

**Source:** coderabbitai
**Type:** comment
**File:** `apps/backend/agents/linear_similarity_agent.py`
**Line:** 309
**Original ID:** 2735948293
**Created:** None
**Severity:** CRITICAL
**Status:** PENDING

---

## Original Content

_âš ï¸ Potential issue_ | _ğŸ”´ Critical_

<details>
<summary>ğŸ§© Analysis chain</summary>

ğŸ Script executed:

```shell
# First, locate and examine the target file
find . -name "linear_similarity_agent.py" -type f
```

Repository: AndyMik90/Auto-Claude

Length of output: 113

---

ğŸ Script executed:

```shell
# Check lines 265-317 in the file
sed -n '265,317p' apps/backend/agents/linear_similarity_agent.py | cat -n
```

Repository: AndyMik90/Auto-Claude

Length of output: 2173

---

ğŸ Script executed:

```shell
# Get broader context around the function to understand the scope
sed -n '250,330p' apps/backend/agents/linear_similarity_agent.py | cat -n
```

Repository: AndyMik90/Auto-Claude

Length of output: 3247

---

ğŸ Script executed:

```shell
# Find the phase_config.py file and examine get_phase_model() signature
find . -name "phase_config.py" -type f
```

Repository: AndyMik90/Auto-Claude

Length of output: 95

---

ğŸ Script executed:

```shell
# Check the get_phase_model() and get_phase_thinking_budget() implementations
grep -A 10 "def get_phase_model" apps/backend/core/phase_config.py
```

Repository: AndyMik90/Auto-Claude

Length of output: 131

---

ğŸ Script executed:

```shell
# Check if there are any existing usages of these functions in the backend
rg "get_phase_model\(" apps/backend/ -A 2 -B 1
```

Repository: AndyMik90/Auto-Claude

Length of output: 2670

---

ğŸ Script executed:

```shell
# Check if the agent function uses context manager pattern
grep -A 50 "async def" apps/backend/agents/linear_similarity_agent.py | head -80
```

Repository: AndyMik90/Auto-Claude

Length of output: 2904

---

ğŸ Script executed:

```shell
# Check how other agents that use get_phase_model handle spec_dir parameter
rg "async def analyze_ticket" apps/backend/ -A 5 -B 2
```

Repository: AndyMik90/Auto-Claude

Length of output: 630

---

ğŸ Script executed:

```shell
# Check planner.py function signature to see if it has spec_dir
rg "async def run_planning" apps/backend/agents/planner.py -A 5
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Check coder.py to see how it gets spec_dir
rg "async def run_coding" apps/backend/agents/coder.py -A 5
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Check if there's any relationship between project_dir and spec_dir in the codebase
rg "spec_dir.*project_dir\|project_dir.*spec_dir" apps/backend/ -B 2 -A 2
```

Repository: AndyMik90/Auto-Claude

Length of output: 47

---

ğŸ Script executed:

```shell
# Look at where analyze_ticket_similarity is called from to understand context
rg "analyze_ticket_similarity" apps/backend/ -B 3 -A 3
```

Repository: AndyMik90/Auto-Claude

Length of output: 1615

---

ğŸ Script executed:

```shell
# Check the runner to see what it passes and if it has spec_dir
cat -n apps/backend/runners/linear_similarity_runner.py
```

Repository: AndyMik90/Auto-Claude

Length of output: 5234

---

ğŸ Script executed:

```shell
# Check other runner files to see how they handle spec_dir
ls -la apps/backend/runners/
```

Repository: AndyMik90/Auto-Claude

Length of output: 1066

---

ğŸ Script executed:

```shell
# Look at a working example - check how QA loop gets spec_dir
rg "async def" apps/backend/qa/loop.py -A 10 | head -50
```

Repository: AndyMik90/Auto-Claude

Length of output: 303

---

ğŸ Script executed:

```shell
# Check phase_config.py to understand the function signatures
cat -n apps/backend/phase_config.py
```

Repository: AndyMik90/Auto-Claude

Length of output: 11731

---



</details>

**Add `spec_dir` parameter and resolve model via phase config before client creation.**

The suggested fix in the original comment contains a critical error: it calls `get_phase_model()` and `get_phase_thinking_budget()` but these functions require `spec_dir` as the first parameter. The `analyze_ticket_similarity()` function currently lacks a `spec_dir` parameter entirely, making it impossible to apply phase configuration.

To implement phase-aware model resolution, the function signature must be updated to accept `spec_dir`:

```diff
async def analyze_ticket_similarity(
    project_dir: str,
+   spec_dir: Path,
    target_ticket_id: str,
    candidate_ticket_ids: list[str] | None = None,
    model: str | None = None,
) -> dict[str, Any]:
```

Then resolve the model and thinking budget:

```diff
    from core.client import create_client
+   from core.phase_config import get_phase_model, get_phase_thinking_budget

    # ... existing validation code ...

    # Create client and run analysis
+   resolved_model = get_phase_model(spec_dir, "qa", model)
+   thinking_budget = get_phase_thinking_budget(spec_dir, "qa")
    client = create_client(
        project_dir=project_dir,
        spec_dir=spec_dir,
        model=resolved_model,
+       thinking_budget=thinking_budget,
        agent_type="linear_similarity",
    )

-   agent = LinearSimilarityAgent(model=model or "claude-3-5-sonnet-20241022")
+   agent = LinearSimilarityAgent(model=resolved_model)
```

Note: The `linear_similarity_runner.py` will also need updating to pass `spec_dir` when calling this function.

<details>
<summary>ğŸ¤– Prompt for AI Agents</summary>

```
In `@apps/backend/agents/linear_similarity_agent.py` around lines 265 - 317, The
analyze_ticket_similarity function is missing a spec_dir parameter so
get_phase_model() and get_phase_thinking_budget(spec_dir, ...) cannot be used;
update the function signature to accept spec_dir, call get_phase_model(spec_dir,
model) and get_phase_thinking_budget(spec_dir, thinking_budget) before creating
the client, pass the resolved model and thinking budget into create_client(...)
and into LinearSimilarityAgent(...), and update any callers (e.g.,
linear_similarity_runner.py) to forward spec_dir when invoking
analyze_ticket_similarity.
```

</details>

<!-- fingerprinting:phantom:medusa:eagle -->

<!-- This is an auto-generated comment by CodeRabbit -->

---

## Suggested Fix

```python
Then resolve the model and thinking budget:
```

---

## Implementation Notes

*Status: PENDING - Not yet verified or implemented*

### Verification Checklist

- [ ] Read file at comment location
- [ ] Verify if issue is already fixed
- [ ] Implement fix if needed
- [ ] Re-verify after implementation

