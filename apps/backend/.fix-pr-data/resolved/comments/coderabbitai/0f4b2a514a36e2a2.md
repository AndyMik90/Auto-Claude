# Comment: 0f4b2a514a36e2a2

**Source:** coderabbitai
**Type:** comment
**File:** `apps/backend/agents/linear_validator.py`
**Original ID:** 2713898407
**Created:** None
**Severity:** HIGH
**Status:** SKIPPED

---

## Original Content

_‚ö†Ô∏è Potential issue_ | _üü† Major_

**JSON extraction regex may fail on nested objects.**

The regex `r"(\{.*?\})"` with non-greedy `*?` will match until the first `}`, which fails for JSON with nested objects (e.g., `{"a": {"b": 1}}`). This will cause JSON parse errors for valid responses.

<details>
<summary>Proposed fix - use a more robust approach</summary>

```diff
     def _parse_validation_result(
         self,
         issue_id: str,
         response: str,
         issue_data: dict[str, Any],
         current_version: str | None,
     ) -> dict[str, Any]:
         import json
         import re

-        # Try to extract JSON from the response
-        json_match = re.search(
-            r"```json\s*(\{.*?\})\s*```", response, re.DOTALL
-        ) or re.search(r"(\{.*?\})", response, re.DOTALL)
+        # Try to extract JSON from code blocks first
+        json_match = re.search(r"```json\s*(\{[\s\S]*?\})\s*```", response)
+        
+        if not json_match:
+            # Try to find JSON by matching balanced braces
+            start = response.find('{')
+            if start != -1:
+                depth = 0
+                for i, char in enumerate(response[start:], start):
+                    if char == '{':
+                        depth += 1
+                    elif char == '}':
+                        depth -= 1
+                        if depth == 0:
+                            try:
+                                return json.loads(response[start:i+1])
+                            except json.JSONDecodeError:
+                                break

         if json_match:
             try:
```
</details>

<details>
<summary>ü§ñ Prompt for AI Agents</summary>

````
In `@apps/backend/agents/linear_validator.py` around lines 696 - 706, The current
JSON extraction using json_match and regex r"(\{.*?\})" fails on nested objects;
update the extraction in the block around json_match and json.loads to first try
extracting a ```json``` code block (json_match = re.search(r"```json...")) and
if that fails, locate the first '{' in response and iteratively scan forward
counting brace depth until it returns to zero to extract a balanced JSON
substring, then call json.loads on that substring, set result["issue_id"] and
result["raw_response"] as before (preserve the existing variables json_match,
response, result, issue_id, raw_response) and fall back to the original regex
only if the balanced-brace extraction fails.
````

</details>

<!-- fingerprinting:phantom:medusa:ocelot -->

<!-- This is an auto-generated comment by CodeRabbit -->

---

## Suggested Fix

```python
</details>

<details>
<summary>ü§ñ Prompt for AI Agents</summary>
```

---

## Implementation Notes

*Status: SKIPPED*

**Resolution:** Already fixed - code now uses balanced brace counting (lines 900-917) which correctly handles nested JSON objects.