{
  "feature": "Fix Insights Conversation Display Issues",
  "workflow_type": "feature",
  "workflow_rationale": "Feature enhancement that adds new functionality (image support) and fixes existing display issues (newlines, thought separators). Involves UI changes, state management updates, and type extensions in a single service (frontend).",
  "phases": [
    {
      "id": "phase-1-types",
      "name": "Type Definitions",
      "type": "implementation",
      "description": "Extend InsightsChatMessage type to support image attachments",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Add images field to InsightsChatMessage type definition",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/shared/types/insights.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/shared/types/task.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd apps/frontend && npx tsc --noEmit",
            "expected": "No TypeScript errors"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-store",
      "name": "Store Logic",
      "type": "implementation",
      "description": "Update insights-store.ts to handle image attachments and thought separators",
      "depends_on": [
        "phase-1-types"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Add image attachment state management to insights-store.ts",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify store compiles with TypeScript and has new image state fields"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Extend sendMessage to include images parameter and clear images after send",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify sendMessage accepts images parameter and clears pending images after adding user message"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-3",
          "description": "Implement thought separator logic in streaming response handler",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/stores/insights-store.ts"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Verify streaming handler inserts visual separators (\\n\\n---\\n\\n) when detecting thought transitions"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-ui",
      "name": "UI Implementation",
      "type": "implementation",
      "description": "Update Insights.tsx component with newline CSS, image handlers, and thumbnail display",
      "depends_on": [
        "phase-1-types",
        "phase-2-store"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add white-space: pre-wrap CSS to user message content for newline preservation",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Open Insights panel",
              "Type multi-line message with Shift+Enter",
              "Send message and verify line breaks preserved"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-2",
          "description": "Implement paste event handler for screenshot support in textarea",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/task-detail/task-review/QAFeedbackSection.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Open Insights panel",
              "Copy screenshot to clipboard",
              "Paste in textarea (Ctrl+V)",
              "Verify thumbnail appears and success message shows"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-3",
          "description": "Implement drag-drop event handlers for image files with visual feedback",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/task-detail/task-review/QAFeedbackSection.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Open Insights panel",
              "Drag image file over textarea",
              "Verify border highlights during drag",
              "Drop file and verify thumbnail appears"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-4",
          "description": "Display image thumbnails inline below textarea with remove buttons",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/task-detail/task-review/QAFeedbackSection.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Add multiple images",
              "Verify thumbnails display in grid layout",
              "Hover over thumbnail and verify remove button appears",
              "Click remove and verify image deleted"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-5",
          "description": "Display images in message bubbles (user and assistant messages)",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/task-detail/task-review/QAFeedbackSection.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Send message with image attachments",
              "Verify images appear in message history",
              "Verify thumbnails render correctly in message bubbles"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-6",
          "description": "Add error handling for image limit (10 max) and invalid types",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/renderer/components/Insights.tsx"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/renderer/components/task-detail/task-review/QAFeedbackSection.tsx"
          ],
          "verification": {
            "type": "browser",
            "url": "http://localhost:3000",
            "checks": [
              "Add 10 images, try to add 11th",
              "Verify error message shows",
              "Try to add non-image file (PDF)",
              "Verify error with allowed types shows"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-7",
          "description": "Add i18n translation keys for new UI text (drag-drop hint, errors, success messages)",
          "service": "frontend",
          "files_to_modify": [
            "apps/frontend/src/shared/i18n/locales/en/tasks.json",
            "apps/frontend/src/shared/i18n/locales/fr/tasks.json"
          ],
          "files_to_create": [],
          "patterns_from": [
            "apps/frontend/src/shared/i18n/locales/en/tasks.json"
          ],
          "verification": {
            "type": "command",
            "command": "cd apps/frontend && npm run build",
            "expected": "Build completes with no missing translation key errors"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-4-integration",
      "name": "Integration & Verification",
      "type": "integration",
      "description": "End-to-end testing of all three fixes (newlines, thought separators, images)",
      "depends_on": [
        "phase-2-store",
        "phase-3-ui"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Verify newline preservation works in practice",
          "all_services": false,
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open Insights panel in running app",
              "Type multi-line message: 'Line 1\\nLine 2\\nLine 3' using Shift+Enter",
              "Send message",
              "Verify display shows three separate lines with proper spacing"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-2",
          "description": "Verify thought separators appear during streaming responses",
          "all_services": false,
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Open Insights panel in running app",
              "Ask question that triggers multi-part response (e.g., 'What are 3 improvements for this project?')",
              "Watch streaming response",
              "Verify visual separators (---) appear between distinct thoughts/paragraphs"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-3",
          "description": "Verify complete image attachment workflow (paste, drag-drop, send, display)",
          "all_services": false,
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Test paste workflow: Copy screenshot → Paste in textarea → Verify thumbnail → Send → Verify in history",
              "Test drag-drop workflow: Drag file → Drop → Verify thumbnail → Send → Verify in history",
              "Test image removal: Add image → Hover → Click remove → Verify deleted",
              "Test limit enforcement: Add 10 images → Try 11th → Verify error"
            ]
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-4",
          "description": "Verify no regressions in existing Insights functionality",
          "all_services": false,
          "service": "frontend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Send text-only message (no images) - verify works",
              "Verify tool usage indicators still appear",
              "Verify task suggestion cards still work",
              "Verify model selector still works",
              "Verify session switching still works",
              "Verify new chat button still works",
              "Check console for no errors or warnings"
            ]
          },
          "status": "completed"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 4,
    "total_subtasks": 15,
    "services_involved": [
      "frontend"
    ],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution - phases have dependencies"
    },
    "startup_command": "cd apps/frontend && npm run dev"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "TypeScript compilation succeeds with no errors",
      "User messages preserve newline characters",
      "Assistant responses show visual thought separators during streaming",
      "Image paste (Ctrl+V) works in Insights textarea",
      "Image drag-drop works with visual feedback",
      "Image thumbnails display below textarea",
      "Image removal buttons work on hover",
      "Image limit enforced (10 max per message)",
      "Invalid file types rejected with error message",
      "Images appear in message history after sending",
      "No console errors during normal operation",
      "Existing functionality (text messages, tool usage, task suggestions) still works"
    ],
    "verification_steps": [
      {
        "name": "TypeScript Compilation",
        "command": "cd apps/frontend && npx tsc --noEmit",
        "expected_outcome": "No TypeScript compilation errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Build Verification",
        "command": "cd apps/frontend && npm run build",
        "expected_outcome": "Build completes successfully with no errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Browser Verification - Newlines",
        "command": "Manual: Open app → Insights → Type multi-line message → Send → Verify line breaks preserved",
        "expected_outcome": "User messages display with proper line breaks",
        "type": "manual",
        "required": true,
        "blocking": false
      },
      {
        "name": "Browser Verification - Thought Separators",
        "command": "Manual: Open app → Insights → Ask multi-part question → Watch streaming → Verify separators appear",
        "expected_outcome": "Visual separators (---) appear between thoughts during streaming",
        "type": "manual",
        "required": true,
        "blocking": false
      },
      {
        "name": "Browser Verification - Image Paste",
        "command": "Manual: Copy screenshot → Paste in textarea → Verify thumbnail → Send → Verify in history",
        "expected_outcome": "Image added, thumbnail displayed, shown in message history",
        "type": "manual",
        "required": true,
        "blocking": false
      },
      {
        "name": "Browser Verification - Image Drag-Drop",
        "command": "Manual: Drag image file → Drop → Verify thumbnail → Verify border highlight during drag",
        "expected_outcome": "Border highlights, image added, thumbnail displayed",
        "type": "manual",
        "required": true,
        "blocking": false
      },
      {
        "name": "Browser Verification - Image Management",
        "command": "Manual: Add images → Hover thumbnails → Click remove → Try to add 11th image → Try invalid file type",
        "expected_outcome": "Remove buttons work, errors show for limit and invalid types",
        "type": "manual",
        "required": true,
        "blocking": false
      },
      {
        "name": "Regression Testing",
        "command": "Manual: Test text-only messages, tool usage, task suggestions, model selector, session switching, new chat",
        "expected_outcome": "All existing features work without issues",
        "type": "manual",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium-risk frontend UI changes require TypeScript compilation verification, build verification, and comprehensive manual browser testing. Unit tests ensure type correctness, integration tests verify store interactions, and manual testing covers UI/UX aspects that are difficult to automate (drag-drop, paste, visual feedback). No security scanning needed as no auth/data handling/external APIs involved."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd apps/frontend && npx tsc --noEmit"
      ],
      "minimum_coverage": null,
      "notes": "TypeScript compilation verifies type correctness. No automated unit test framework setup required for these UI changes."
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd apps/frontend && npm run build"
      ],
      "services_to_test": [
        "frontend"
      ],
      "notes": "Build verification ensures component and store integration works correctly."
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": [],
      "notes": "E2E testing handled by manual browser verification steps in verification_strategy."
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "http://localhost:3000",
          "checks": [
            "User messages preserve newlines (Shift+Enter creates line breaks that display correctly)",
            "Assistant streaming responses show visual separators (---) between thoughts",
            "Textarea shows drag-drop hint text",
            "Pasting image (Ctrl+V) adds thumbnail and shows success message",
            "Dragging image over textarea highlights border",
            "Dropping image adds thumbnail",
            "Image thumbnails display in grid layout below textarea",
            "Hovering over thumbnail shows remove button",
            "Clicking remove deletes image from attachments",
            "Adding 10 images then trying to add 11th shows error message",
            "Trying to add non-image file shows error with allowed types",
            "Sending message with images includes them in the message",
            "Images appear in message history after sending",
            "Text-only messages still work",
            "Tool usage indicators still appear",
            "Task suggestion cards still work",
            "No console errors or warnings during normal operation"
          ]
        }
      ]
    },
    "database_verification": {
      "required": false,
      "checks": [],
      "notes": "No database changes - all data stored locally in electron store."
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-18T01:28:10.190Z",
  "recoveryNote": "Task recovered from stuck state at 2026-01-18T00:32:22.247Z"
}